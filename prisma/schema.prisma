// This is your Prisma schema file,schema
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ENUMS

enum TokenType {
  ACCESS
  REFRESH
  RESET_PASSWORD
  VERIFY_EMAIL
  IS_USER_UPDATE_DATA
}

enum RoleName {
  ADMIN
  CASHIER
  WAITER
  KITCHEN_MANAGER
}

enum TableStatus {
  AVAILABLE
  OCCUPIED
  NEEDS_CLEANING
}

enum OrderStatus {
  PENDING
  SENT_TO_CASHIER
  PAID
  CANCELLED
  IN_KITCHEN
  READY
  DELIVERED
}

enum OrderType {
  DINE_IN
  TAKE_OUT
  DELIVERY
  WHATSAPP
}

enum PaymentMethod {
  CASH
  NEQUI
  TICKET_BOOK
}

// DATA-MODELS

model Token {
  id          String    @id @default(uuid())
  token       String
  type        TokenType
  expires     DateTime
  blacklisted Boolean
  createdAt   DateTime  @default(now())
  userId      String
  user        User      @relation(fields: [userId], references: [id])
}

model Role {
  id          Int      @id @default(autoincrement())
  name        RoleName @unique
  description String?

  permissions RolePermission[]
  users       UserRole[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  deleted   Boolean   @default(false)
  deletedAt DateTime? @map("deleted_at")

  @@map("roles")
}

model Permission {
  id          Int     @id @default(autoincrement())
  name        String  @unique
  description String?

  roles RolePermission[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  deleted   Boolean   @default(false)
  deletedAt DateTime? @map("deleted_at")

  @@map("permissions")
}

model RolePermission {
  roleId Int  @map("role_id")
  role   Role @relation(fields: [roleId], references: [id])

  permissionId Int        @map("permission_id")
  permission   Permission @relation(fields: [permissionId], references: [id])

  assignedAt DateTime @default(now()) @map("assigned_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

model User {
  id        String  @id @default(uuid())
  firstName String  @map("first_name")
  lastName  String  @map("last_name")
  email     String  @unique
  phone     String? @unique
  password  String

  roles UserRole[]

  profile Profile?

  token Token[]

  ordersTaken        Order[]   @relation("OrdersTakenByWaiter")
  registeredExpenses Expense[] @relation("ExpensesRecordedBy")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  deleted   Boolean   @default(false)
  deletedAt DateTime? @map("deleted_at")

  @@map("users")
}

model UserRole {
  roleId Int  @map("role_id")
  role   Role @relation(fields: [roleId], references: [id])

  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id])

  assignedAt DateTime @default(now()) @map("assigned_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@id([roleId, userId])
  @@map("user_roles")
}

model Profile {
  id     String @id @default(uuid())
  userId String @unique @map("user_id")
  user   User   @relation(fields: [userId], references: [id])

  photoUrl       String?   @map("photo_url")
  birthDate      DateTime? @map("birthDate")
  identification String?
  address        String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  deleted   Boolean   @default(false)
  deletedAt DateTime? @map("deleted_at")

  @@map("profiles")
}

model Table {
  id       Int         @id @default(autoincrement())
  number   String      @unique
  status   TableStatus @default(AVAILABLE)
  location String?

  orders Order[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  deleted   Boolean   @default(false)
  deletedAt DateTime? @map("deleted_at")

  @@map("tables")
}

/**
 * MenuCategory Model
 * Categories for organizing menu items (e.g., Sopas, Principios, Prote√≠nas, etc.)
 */
model MenuCategory {
  id          Int     @id @default(autoincrement())
  name        String  @unique
  description String?
  order       Int     @default(0)

  items MenuItem[]

  // Relations for daily menu configuration
  dailyMenuSoups     DailyMenu[] @relation("DailyMenuSoups")
  dailyMenuPrinciples DailyMenu[] @relation("DailyMenuPrinciples")
  dailyMenuProteins  DailyMenu[] @relation("DailyMenuProteins")
  dailyMenuDrinks    DailyMenu[] @relation("DailyMenuDrinks")
  dailyMenuExtras    DailyMenu[] @relation("DailyMenuExtras")

  deleted   Boolean   @default(false)
  deletedAt DateTime? @map("deleted_at")

  @@map("menu_categories")
}

/**
 * MenuItem Model
 * Simplified - removed unused fields for corrientazo
 */
model MenuItem {
  id         Int          @id @default(autoincrement())
  categoryId Int          @map("category_id")
  category   MenuCategory @relation(fields: [categoryId], references: [id])

  name        String
  description String?
  price       Decimal @db.Decimal(10, 2)
  isAvailable Boolean @default(true) @map("is_available")
  imageUrl    String? @map("image_url")

  // Inventory management
  inventoryType       String  @default("UNLIMITED") @map("inventory_type")
  stockQuantity       Int?    @map("stock_quantity")
  initialStock        Int?    @map("initial_stock")
  lowStockAlert       Int?    @default(5) @map("low_stock_alert")
  autoMarkUnavailable Boolean @default(true) @map("auto_mark_unavailable)")

  // Relations - Daily Menu options (each option has unique relation name)
  dailyMenuAsSoupOption1     DailyMenu[] @relation("DailyMenuSoupOption1")
  dailyMenuAsSoupOption2     DailyMenu[] @relation("DailyMenuSoupOption2")
  dailyMenuAsPrincipleOption1 DailyMenu[] @relation("DailyMenuPrincipleOption1")
  dailyMenuAsPrincipleOption2 DailyMenu[] @relation("DailyMenuPrincipleOption2")
  dailyMenuAsProteinOption1  DailyMenu[] @relation("DailyMenuProteinOption1")
  dailyMenuAsProteinOption2  DailyMenu[] @relation("DailyMenuProteinOption2")
  dailyMenuAsProteinOption3  DailyMenu[] @relation("DailyMenuProteinOption3")
  dailyMenuAsDrinkOption1    DailyMenu[] @relation("DailyMenuDrinkOption1")
  dailyMenuAsDrinkOption2    DailyMenu[] @relation("DailyMenuDrinkOption2")
  dailyMenuAsExtraOption1    DailyMenu[] @relation("DailyMenuExtraOption1")
  dailyMenuAsExtraOption2    DailyMenu[] @relation("DailyMenuExtraOption2")
  orderItems          OrderItem[]
  stockAdjustments    StockAdjustment[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  deleted   Boolean   @default(false)
  deletedAt DateTime? @map("deleted_at")

  @@unique([categoryId, name])
  @@map("menu_items")
}

model StockAdjustment {
  id         String   @id @default(uuid())
  menuItemId Int      @map("menu_item_id")
  menuItem   MenuItem @relation(fields: [menuItemId], references: [id])

  adjustmentType String // 'DAILY_RESET' | 'MANUAL_ADD' | 'ORDER_DEDUCT' | "MANUAL_REMOVE" | 'ORDER_CANCELLED'
  previousStock  Int    @map("previous_stock")
  newStock       Int    @map("new_stock")
  quantity       Int

  reason  String?
  userId  String? @map("user_id")
  orderId String? @map("order_id")

  createdAt DateTime @default(now()) @map("created_at")

  @@map("stock_adjustments")
}

model Order {
  id      String @id @default(uuid())
  tableId Int?   @map("table_id")
  table   Table? @relation(fields: [tableId], references: [id])

  waiterId String @map("waiter_id")
  waiter   User   @relation("OrdersTakenByWaiter", fields: [waiterId], references: [id])

  customerId String?   @map("customerId")
  customer   Customer? @relation(fields: [customerId], references: [id])

  status OrderStatus @default(PENDING)
  type   OrderType   @default(DINE_IN)

  totalAmount Decimal @default(0.00) @map("total_amount") @db.Decimal(10, 2)
  notes       String?

  whatsappOrderId String? @unique @map("whatsapp_order_id")

  items    OrderItem[]
  payments Payment[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("orders")
}

model OrderItem {
  id      Int    @id @default(autoincrement())
  orderId String @map("order_id")
  order   Order  @relation(fields: [orderId], references: [id])

  menuItemId Int?      @map("menu_item_id")
  menuItem   MenuItem? @relation(fields: [menuItemId], references: [id])

  quantity     Int
  priceAtOrder Decimal @map("price_at_order") @db.Decimal(10, 2)
  notes        String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("order_items")
}

model Customer {
  id        String  @id @default(uuid())
  firstName String  @map("first_name")
  lastName  String  @map("last_name")
  phone     String  @unique
  email     String?

  orders      Order[]
  ticketBooks TicketBook[]
  dailyCodes  DailyTicketBookCode[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  deleted   Boolean   @default(false)
  deletedAt DateTime? @map("deleted_at")

  @@map("customers")
}

model TicketBook {
  id String @id @default(uuid())

  customerId String?   @map("customerId")
  customer   Customer? @relation(fields: [customerId], references: [id])

  purchaseDate     DateTime @default(now()) @map("purchase_date")
  expiryDate       DateTime @map("expiry_date")
  totalPortions    Int      @map("total_portions")
  consumedPortions Int      @default(0) @map("consumed_portions")

  status String @default("active")

  usages TicketBookUsage[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("ticket_books")
}

model TicketBookUsage {
  id           String     @id @default(uuid())
  ticketBookId String     @map("ticket_book_id")
  ticketBook   TicketBook @relation(fields: [ticketBookId], references: [id])

  paymentId String  @map("payment_id")
  payments  Payment @relation("TicketUsages", fields: [paymentId], references: [id])

  dailyCodeId String              @map("daily_code_id")
  dailyCode   DailyTicketBookCode @relation(fields: [dailyCodeId], references: [id])

  portionCount Int @default(1) @map("portion_count")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("ticket_book_usages")
}

model Payment {
  id String @id @default(uuid())

  orderId String? @map("order_id")
  order   Order?  @relation(fields: [orderId], references: [id])

  method PaymentMethod @default(CASH)
  amount Decimal       @db.Decimal(10, 2)

  transactionRef String? @map("transaction_ref")

  ticketUsages          TicketBookUsage[]    @relation("TicketUsages")
  dailyTicketBookCodeId String?              @unique @map("daily_ticket_book_code_id")
  dailyTicketBookCode   DailyTicketBookCode? @relation("CodeUsedInPayment", fields: [dailyTicketBookCodeId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")

  @@map("payments")
}

model ExpenseCategory {
  id          Int     @id @default(autoincrement())
  name        String
  description String?

  expenses Expense[]

  @@map("expense_categories")
}

model Expense {
  id Int @id @default(autoincrement())

  recordedById String @map("recorded_by_id")
  recordedBy   User   @relation("ExpensesRecordedBy", fields: [recordedById], references: [id])

  categoryId Int             @map("category_id")
  category   ExpenseCategory @relation(fields: [categoryId], references: [id])

  date        DateTime
  amount      Decimal  @db.Decimal(10, 2)
  description String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  deleted   Boolean   @default(false)
  deletedAt DateTime? @map("deleted_at")

  @@map("expenses")
}

model DailyTicketBookCode {
  id String @id @default(uuid())

  customerId String?   @map("customerId")
  customer   Customer? @relation(fields: [customerId], references: [id])

  code String   @unique
  date DateTime @db.Date

  isUsed Boolean @default(false) @map("is_used")

  usedAtPaymentId Int?              @unique @map("used_at_payment_id")
  usedAtPayment   Payment?          @relation("CodeUsedInPayment")
  ticketBookUsage TicketBookUsage[]

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([customerId, date])
  @@map("daily_ticket_book_codes")
}

/**
 * DailyMenu Model
 * Redesigned to store references to actual MenuItems
 * Each day can have multiple options for soup, principle, protein, drink, and extra
 */
model DailyMenu {
  id        String   @id @default(uuid())
  date      DateTime @unique @db.Date
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Price configuration based on protein selection
  basePrice          Decimal  @default(10000.00) @db.Decimal(10, 2) @map("base_price") // Price for standard proteins (chicken, pork)
  premiumProteinPrice Decimal @default(11000.00) @db.Decimal(10, 2) @map("premium_protein_price") // Price for premium proteins (beef, fish)

  // Category references (for grouping/organization)
  soupCategoryId     Int?          @map("soup_category_id")
  soupCategory       MenuCategory? @relation("DailyMenuSoups", fields: [soupCategoryId], references: [id])
  
  principleCategoryId Int?          @map("principle_category_id")
  principleCategory   MenuCategory? @relation("DailyMenuPrinciples", fields: [principleCategoryId], references: [id])
  
  proteinCategoryId  Int?          @map("protein_category_id")
  proteinCategory    MenuCategory? @relation("DailyMenuProteins", fields: [proteinCategoryId], references: [id])
  
  drinkCategoryId    Int?          @map("drink_category_id")
  drinkCategory      MenuCategory? @relation("DailyMenuDrinks", fields: [drinkCategoryId], references: [id])
  
  extraCategoryId    Int?          @map("extra_category_id")
  extraCategory      MenuCategory? @relation("DailyMenuExtras", fields: [extraCategoryId], references: [id])

  // Available items for today (up to 2 options each, except protein which can have more)
  soupOption1Id     Int?      @map("soup_option_1_id")
  soupOption1       MenuItem? @relation("DailyMenuSoupOption1", fields: [soupOption1Id], references: [id])
  
  soupOption2Id     Int?      @map("soup_option_2_id")
  soupOption2       MenuItem? @relation("DailyMenuSoupOption2", fields: [soupOption2Id], references: [id])
  
  principleOption1Id Int?      @map("principle_option_1_id")
  principleOption1   MenuItem? @relation("DailyMenuPrincipleOption1", fields: [principleOption1Id], references: [id])
  
  principleOption2Id Int?      @map("principle_option_2_id")
  principleOption2   MenuItem? @relation("DailyMenuPrincipleOption2", fields: [principleOption2Id], references: [id])
  
  proteinOption1Id  Int?      @map("protein_option_1_id")
  proteinOption1    MenuItem? @relation("DailyMenuProteinOption1", fields: [proteinOption1Id], references: [id])
  
  proteinOption2Id  Int?      @map("protein_option_2_id")
  proteinOption2    MenuItem? @relation("DailyMenuProteinOption2", fields: [proteinOption2Id], references: [id])
  
  proteinOption3Id  Int?      @map("protein_option_3_id")
  proteinOption3    MenuItem? @relation("DailyMenuProteinOption3", fields: [proteinOption3Id], references: [id])
  
  drinkOption1Id    Int?      @map("drink_option_1_id")
  drinkOption1      MenuItem? @relation("DailyMenuDrinkOption1", fields: [drinkOption1Id], references: [id])
  
  drinkOption2Id    Int?      @map("drink_option_2_id")
  drinkOption2      MenuItem? @relation("DailyMenuDrinkOption2", fields: [drinkOption2Id], references: [id])
  
  extraOption1Id    Int?      @map("extra_option_1_id")
  extraOption1      MenuItem? @relation("DailyMenuExtraOption1", fields: [extraOption1Id], references: [id])
  
  extraOption2Id    Int?      @map("extra_option_2_id")
  extraOption2      MenuItem? @relation("DailyMenuExtraOption2", fields: [extraOption2Id], references: [id])

  @@index([date])
  @@index([isActive])
  @@map("daily_menus")
}
